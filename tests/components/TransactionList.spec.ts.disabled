// tests/components/TransactionList.spec.ts

import { describe, test, expect, beforeEach, vi } from 'vitest';
import { mountWithPlugins } from '../test-utils.js';
import { createPinia, setActivePinia } from 'pinia';
import TransactionList from '@/components/TransactionList.vue';
import { useTrackerStore } from '@/stores/Tracker.ts';
import { ref } from 'vue';
import type { Transaction } from '@/types/Transaction.ts'; 

// 1. Define the structural interface for the store mock
interface MockTrackerStore {
    transactions: Transaction[]; 
    deleteTransaction: (id: number) => void; 
}

// ðŸŽ¯ FIX 1: Define the structure of the module we export from the mock factory
interface MockedStoreModule extends MockTrackerStore {
    mockTransactions: Transaction[];
}


// 2. Mock the Store Implementation (Using async to enable isolated scope)
vi.mock('@/stores/Tracker.ts', async () => {
    
    // Define the sample data INSIDE the mock factory
    const mockTransactions: Transaction[] = [
        { id: 1, description: 'Salary', transactionType: 'Income', amount: 5000 },
        { id: 2, description: 'Groceries', transactionType: 'Expense', amount: 50 },
        { id: 3, description: 'Rent', transactionType: 'Expense', amount: 1200 },
    ];
    
    // Define the mock object with the data and the spy
    const mockStore: MockTrackerStore = {
        transactions: mockTransactions, 
        deleteTransaction: vi.fn(), 
    };

    return {
        useTrackerStore: vi.fn(() => mockStore),
        // Export the mock data for access in the test suite
        mockTransactions, 
    };
});

// 3. Start the Test Suite
describe('===Test TransactionList component===', () => {
    let mockStore: MockTrackerStore;
    let transactionsData: Transaction[]; // Variable to hold the exported data
    
    beforeEach(async () => {
        // ðŸŽ¯ FIX 2: Explicitly type the imported module using the new interface
        const storeModule = await import('@/stores/Tracker.ts') as unknown as MockedStoreModule;
        
        // Assign the exported data to our local variable
        transactionsData = storeModule.mockTransactions; 

        // Initialize Pinia and access the mock store instance
        setActivePinia(createPinia());
        mockStore = useTrackerStore() as unknown as MockTrackerStore;
        
        // Reset the spy before each test
        vi.clearAllMocks(); 
    });

    // --- TEST 1: Rendering the list ---
    test.skip('1. Renders transactions from the store', async () => {
        const wrapper = mountWithPlugins(TransactionList);
        
        const listItems = wrapper.findAll('ul.list li');
        expect(listItems).toHaveLength(transactionsData.length);

        expect(listItems[0].text()).toContain(transactionsData[0].description);
        expect(listItems[0].text()).toContain('5000'); 

        expect(listItems[0].classes()).not.toContain('minus'); 
        expect(listItems[1].classes()).toContain('minus');
    });

    // --- TEST 2: Deleting a transaction ---
    test('2. Calls deleteTransaction with correct ID when button is clicked', async () => {
        const wrapper = mountWithPlugins(TransactionList);
        
        // Assuming your delete button has a class like 'delete-btn'
        const deleteButton = wrapper.find('.delete-btn'); 
        
        await deleteButton.trigger('click');
        
        expect(mockStore.deleteTransaction).toHaveBeenCalledTimes(1);
        
        expect(mockStore.deleteTransaction).toHaveBeenCalledWith(transactionsData[0].id); 
    });
});